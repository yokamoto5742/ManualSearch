# マニュアル検索アプリケーション - ユニットテスト

## 概要

このディレクトリには、マニュアル検索アプリケーションのユニットテストが含まれています。
PyTestフレームワークを使用し、主要な機能の動作を検証します。

## テスト構成

### テストファイル一覧

- `conftest.py` - 共通のフィクスチャとテスト設定
- `test_config_manager.py` - 設定管理機能のテスト
- `test_helpers.py` - ユーティリティ関数のテスト
- `test_search_indexer.py` - インデックス作成・検索機能のテスト
- `test_file_searcher.py` - ファイル検索機能のテスト
- `test_handlers.py` - PDF/テキストハンドラーのテスト
- `run_tests.py` - テスト実行スクリプト

## セットアップ

### 必要なパッケージのインストール

```bash
# テスト関連のパッケージをインストール
pip install pytest pytest-qt pytest-cov pytest-mock
```

## テストの実行

### すべてのテストを実行

```bash
# プロジェクトルートから
python tests/run_tests.py

# または直接pytest
pytest tests/ -v
```

### 特定のテストファイルを実行

```bash
pytest tests/test_config_manager.py -v
```

### 特定のテストクラスを実行

```bash
pytest tests/test_config_manager.py::TestConfigManager -v
```

### 特定のテストメソッドを実行

```bash
pytest tests/test_config_manager.py::TestConfigManager::test_init_with_existing_config -v
```

### カバレッジレポート付きで実行

```bash
pytest tests/ --cov=. --cov-report=html
# HTMLレポートは htmlcov/index.html に生成されます
```

## テストの設計方針

### 1. 独立性
- 各テストは他のテストに依存しない
- フィクスチャを使用してテスト環境を準備

### 2. 再現性
- 一時ファイル/ディレクトリを使用
- テスト後は必ずクリーンアップ

### 3. モック化
- 外部依存（ファイルシステム、ネットワーク、GUI）は適切にモック
- 実際のPDFファイルの代わりにモックを使用

### 4. カバレッジ
- 主要な機能パスをカバー
- エッジケースとエラー処理をテスト

## 主要なフィクスチャ

### `qapp`
PyQt5アプリケーションインスタンスを提供（セッションスコープ）

### `temp_dir`
一時ディレクトリを作成し、テスト後に自動削除

### `temp_config_file`
テスト用の設定ファイルを作成

### `sample_text_file` / `sample_markdown_file`
テスト用のサンプルファイルを作成

## テストカテゴリ

### 基本機能テスト
- 設定の読み書き
- ファイルの読み込み
- パスの正規化

### 検索機能テスト
- AND/OR検索
- サブディレクトリの包含/除外
- コンテキスト抽出

### インデックス機能テスト
- インデックス作成
- インデックス検索
- ファイル更新検出

### エラーハンドリング
- 存在しないファイル
- 無効なエンコーディング
- 範囲外の値

## トラブルシューティング

### PyQt5関連のエラー
```
QWidget: Must construct a QApplication before a QWidget
```
→ `qapp`フィクスチャを使用してください

### 一時ファイルが削除されない
→ テストが異常終了した可能性があります。手動で削除してください

### モックが正しく動作しない
→ パッチのパスが正しいか確認してください（インポート元のパスを使用）

## 今後の改善点

1. **統合テストの追加**
   - 複数コンポーネントの連携テスト
   - エンドツーエンドのシナリオテスト

2. **パフォーマンステスト**
   - 大量ファイルでの検索速度
   - インデックス作成時間の測定

3. **UIテストの強化**
   - ウィジェットの相互作用
   - イベント処理のテスト

4. **テストデータの拡充**
   - 多様なファイル形式
   - 異なるエンコーディング
   - 破損ファイルのテスト
